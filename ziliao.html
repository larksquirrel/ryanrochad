<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Ryan Rochad</title>

<style type="text/css">
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  font-family: Arial, sans-serif;
  line-height: 1.6;
  padding-bottom: 40px;
  background-color: #f4f4f4;
}
header {
  background-color: #f8f8f8;
  padding: 15px;
}
nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.logo {
  font-size: 28px;
  color: #000;
}
.nav-links {
  display: flex;
  list-style: none;
}
.nav-links li {
  margin-left: 30px;
}
.search-bar {
  display: flex;
  align-items: center;
}
.search-bar input {
  padding: 8px 12px;
  border: 1px solid #ccc;
  border-radius: 3px;
  width: 300px;
}
.search-bar button {
  background-color: transparent;
  border: none;
  cursor: pointer;
}
.user-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}
.account-section {
  background-color: #f4f4f4;
  padding: 30px;
  text-align: center;
}
.welcome-message {
  text-align: right;
}
.account-details {
  display: flex;
  padding: 30px;
  gap: 20px;
}
.sidebar {
  width: 200px;
  background-color: #f4f4f4;
}
.sidebar ul {
  list-style: none;
}
.sidebar ul li {
  padding: 10px;
}
.main-content {
  flex: 1;
  background-color: #fff;
  padding: 20px;
  border-radius: 8px;
}
.info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  gap: 10px;
}
.info-row span {
  min-width: 160px;
  display: inline-block;
}
.password-box {
  display: flex;
  align-items: center;
  gap: 8px;
}
.password-text {
  font-size: 16px;
  letter-spacing: 3px;
  cursor: pointer;
  user-select: none;
}
button {
  background-color: #004080;
  color: #fff;
  border: none;
  padding: 10px 20px;
  cursor: pointer;
  border-radius: 4px;
}
button:hover {
  background-color: #003366;
}
.preferences-section {
  background-color: #f4f4f4;
  padding: 30px;
  margin-top: 20px;
}

.nav-links a {
    text-decoration: none;
    color: inherit;
}

.nav-links a:hover {
    text-decoration: none;
    color: inherit;
}

.nav-links a:visited {
    color: inherit;
}

.nav-links a:active {
    color: inherit;
}

.nav-links li {
    cursor: pointer;
}

.logout-btn {
  background-color: #ff4444;
  margin-left: 10px;
}

.logout-btn:hover {
  background-color: #cc0000;
}
</style>

<!-- ✅ 引入 Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const { createClient } = supabase;
const client = createClient(
  'https://nixlipqiyezzfvwqtdzj.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5peGxpcHFpeWV6emZ2d3F0ZHpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMTIxODEsImV4cCI6MjA3NzU4ODE4MX0.rZvDmHfMkF5gZM2VWSQuS35LfWL2naJqScVY1Z8g0B4'
);

// ✅ 加载用户信息
async function loadProfile() {
  console.log('开始加载用户信息...');

  try {
    const { data: { user }, error } = await client.auth.getUser();

    console.log('获取用户结果:', { user: user ? user.email : '未登录', error });

    if (error || !user) {
      console.log('用户未登录或获取失败');
      document.getElementById("display-username").textContent = "NOT";
      document.getElementById("display-email").textContent = "NOT";
      document.getElementById("welcome-text").textContent = "Welcome, Guest!";

      // 禁用需要登录的功能
      const changePwdBtn = document.querySelector('button[onclick="changePassword()"]');
      if (changePwdBtn) {
        changePwdBtn.disabled = true;
        changePwdBtn.textContent = "Please login to change password";
        changePwdBtn.style.backgroundColor = "#ccc";
        changePwdBtn.style.cursor = "not-allowed";
      }

      // 隐藏登出按钮
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.style.display = 'none';
      }

      return;
    }

    // 有用户登录时正常显示信息
    console.log('用户已登录:', user.email);
    const username = user.user_metadata?.username || "User";
    const email = user.email || "Not provided";

    document.getElementById("display-username").textContent = username;
    document.getElementById("display-email").textContent = email;
    document.getElementById("welcome-text").textContent = `Welcome, ${username}!`;

    // 启用功能按钮
    const changePwdBtn = document.querySelector('button[onclick="changePassword()"]');
    if (changePwdBtn) {
      changePwdBtn.disabled = false;
      changePwdBtn.textContent = "Change your password";
      changePwdBtn.style.backgroundColor = "";
      changePwdBtn.style.cursor = "pointer";
    }

    // 显示登出按钮
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.style.display = 'inline-block';
    }

    console.log('用户信息显示完成');

  } catch (err) {
    console.error("Error loading profile:", err);
    document.getElementById("display-username").textContent = "NOT";
    document.getElementById("display-email").textContent = "NOT";
    document.getElementById("welcome-text").textContent = "Welcome, Guest!";
  }
}

// ✅ 修改密码
async function changePassword() {
  // 检查用户是否登录
  const { data: { user } } = await client.auth.getUser();
  if (!user) {
    alert("Please login to change password");
    return;
  }

  const current = prompt("Enter your current password:");
  const newPass = prompt("Enter your new password:");
  const confirm = prompt("Confirm your new password:");

  if (!current || !newPass || !confirm) {
    alert("Password fields cannot be empty.");
    return;
  }
  if (newPass !== confirm) {
    alert("New passwords do not match.");
    return;
  }

  try {
    // 先登录验证旧密码
    const { data: login, error: loginErr } = await client.auth.signInWithPassword({
      email: user.email,
      password: current
    });
    if (loginErr) {
      alert("Current password is incorrect.");
      return;
    }

    // 更新密码
    const { error } = await client.auth.updateUser({ password: newPass });
    if (error) throw error;

    // 更新本地缓存
    localStorage.setItem("user_password", newPass);
    alert("Password updated successfully!");
  } catch (err) {
    alert("Error updating password: " + err.message);
  }
}

// ✅ 登出功能
async function logout() {
  try {
    const { error } = await client.auth.signOut();
    if (error) throw error;

    // 清除本地存储的密码
    localStorage.removeItem("user_password");

    // 重新加载页面
    window.location.reload();
  } catch (err) {
    alert("Logout error: " + err.message);
  }
}

// 页面加载时初始化
document.addEventListener("DOMContentLoaded", function() {
  loadProfile();
});
</script>
</head>

<body>
<header>
  <nav>
    <div class="logo">Ryan Rochad's</div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="zhuye.html">About Us</a></li>
      <li>Services</li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="dl.html">Login</a></li>
      <li>Account</li>
    </ul>
    <div class="search-bar">
      <input type="text" placeholder="搜索瑞恩罗恰德">
      <button type="submit">
        <img src="images/3cf56231255d641f25bad5ba1f3f80c.jpg" alt="搜索图标" width="16" height="16">
      </button>
    </div>
  </nav>
</header>

<main>
  <section class="account-section">
    <h1>Account information</h1>
    <p>If you have any problems with your account, please contact customer service</p>
    <div class="welcome-message">
      <p id="welcome-text">Welcome</p>
    </div>
  </section>

  <section class="account-details">
    <div class="sidebar">
      <ul>
        <li>Account information</li>
        <li>Auction</li>
        <li>Information</li>
        <li>Purchase history</li>
        <li>Seller Central</li>
      </ul>
    </div>

    <div class="main-content">
      <h2>Account information</h2>
      <div class="info-row">
        <span>Username: <span id="display-username">Loading...</span></span>
        <span>Email: <span id="display-email">Loading...</span></span>
        <button onclick="changePassword()">Change your password</button>
        <button id="logout-btn" onclick="logout()" class="logout-btn" style="display: none;">Logout</button>
      </div>

      <div class="verification-status"></div>
      <p><button class="complete-profile">Complete filling in your account information</button></p>
    </div>
  </section>

  <section class="preferences-section">
    <h2>Account and auction preferences</h2>
    <p>Please login to view and manage your preferences</p>
  </section>
</main>

</body>
</html>